<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1920, height=1080" />
  <title>Friendship Heights Events (Signage)</title>

  <style>
    :root{
      --pad-x: 60px;
      --pad-y: 40px;
      --gap: 30px;
      --card-radius: 16px;
      --title-size: 42px;
      --month-size: 36px;
      --card-title: 26px;
      --card-meta: 18px;
      --badge-bg: #007bff;
    }

    body{
      margin:0;
      background:#fff;
      font-family: Arial, Helvetica, sans-serif;
      color:#000;
    }

    .wrapper{ padding: var(--pad-y) var(--pad-x); }

    .header{
      display:flex;
      align-items:center;
      margin-bottom: 40px;
    }
    .header img{ height:90px; margin-right:30px; }
    .header h1{ font-size: var(--title-size); margin:0; }

    .month{
      font-size: var(--month-size);
      margin: 35px 0 20px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
    }

    .card{
      position:relative;
      border-radius: var(--card-radius);
      overflow:hidden;
      background:#eee;
    }

    .card img{
      width:100%;
      height:360px;
      object-fit:cover;
      display:block;
    }

    .overlay{
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.75));
    }

    .card-content{
      position:absolute;
      left:20px;
      right:20px;
      bottom:20px;
      color:#fff;
    }

    .card-content h2{
      font-size: var(--card-title);
      margin:0 0 10px;
      line-height: 1.15;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }

    .meta{
      font-size: var(--card-meta);
      line-height: 1.25;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }

    .badge{
      position:absolute;
      top:15px;
      left:15px;
      background: var(--badge-bg);
      color:#fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      z-index: 3;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }

    .status{
      font-size: 22px;
      margin-top: 18px;
      max-width: 1200px;
      line-height: 1.35;
    }

    .tiny{
      font-size: 16px;
      opacity: .85;
      margin-top: 10px;
    }

    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background:#f2f2f2;
      border:1px solid #e4e4e4;
      font-size: 14px;
      margin-right: 8px;
    }

    .hr{
      height:1px;
      background:#eee;
      margin: 20px 0;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="header">
      <img src="https://friendshipheightsmd.gov/wp-content/uploads/2023/07/fh-logo.png" alt="Friendship Heights logo" />
      <h1>Friendship Heights Village Events Calendar</h1>
    </div>

    <div id="content">
      <div class="status">Loading events…</div>
      <div class="tiny">If this message persists, the events feed may be blocked by browser cross-site rules (CORS). This is easy to fix—see the message that will appear below.</div>
    </div>
  </div>

<script>
/**
 * CONFIG
 * You can tweak these without touching the rest.
 */
const CONFIG = {
  siteOrigin: "https://friendshipheightsmd.gov",
  monthsToShow: 2,          // current month + next month
  cardsPerMonth: 3,         // how many cards to show under each month header
  maxEventsToFetch: 50,      // more = more robust, slightly heavier
  timezone: "America/New_York",
  // If you want the signage to auto-refresh every N minutes, set refreshMinutes > 0.
  refreshMinutes: 15
};

// A small neutral fallback image (SVG data URI) to ensure no blank cards.
const FALLBACK_IMAGE =
  "data:image/svg+xml;charset=utf-8," +
  encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#e9e9e9"/>
          <stop offset="1" stop-color="#d9d9d9"/>
        </linearGradient>
      </defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <text x="50%" y="52%" text-anchor="middle" font-family="Arial" font-size="44" fill="#666">
        Friendship Heights Event
      </text>
    </svg>
  `);

/**
 * FEEDS (try best → fallback)
 * Primary: The Events Calendar REST API (recommended for event dates/times) :contentReference[oaicite:1]{index=1}
 * Fallback: WP v2 custom post type endpoint (some sites expose dates differently)
 */
const FEEDS = [
  {
    name: "The Events Calendar REST",
    url: `${CONFIG.siteOrigin}/wp-json/tribe/events/v1/events?per_page=${CONFIG.maxEventsToFetch}&page=1&orderby=start_date&order=asc`,
    parse: parseTribeEventsV1
  },
  {
    name: "WP v2 tribe_events",
    url: `${CONFIG.siteOrigin}/wp-json/wp/v2/tribe_events?per_page=${Math.min(CONFIG.maxEventsToFetch, 100)}&_embed`,
    parse: parseWpV2TribeEvents
  }
];

function $(id){ return document.getElementById(id); }

function safeText(html){
  // Remove any tags; keep readable text
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return (div.textContent || div.innerText || "").trim();
}

function fmtMonthKey(d){
  return new Intl.DateTimeFormat("en-US", { month:"long", year:"numeric", timeZone: CONFIG.timezone }).format(d);
}

function fmtDateTimeRange(start, end){
  const dateFmt = new Intl.DateTimeFormat("en-US", { weekday:"short", month:"short", day:"numeric", timeZone: CONFIG.timezone });
  const timeFmt = new Intl.DateTimeFormat("en-US", { hour:"numeric", minute:"2-digit", timeZone: CONFIG.timezone });

  const sameDay = start.toDateString() === end.toDateString();
  const dayPart = dateFmt.format(start);
  const startTime = timeFmt.format(start);
  const endTime = timeFmt.format(end);

  // Handle all-day-ish events (some feeds set midnight)
  const looksAllDay = (startTime === "12:00 AM" && endTime === "12:00 AM") || (start.getHours()===0 && start.getMinutes()===0 && end.getHours()===0 && end.getMinutes()===0);

  if (looksAllDay) return `${dayPart} · All day`;

  if (sameDay) return `${dayPart} · ${startTime}–${endTime}`;
  return `${dayPart} · ${startTime} → ${dateFmt.format(end)} ${endTime}`;
}

function isNextUp(start){
  const now = new Date();
  const diff = start - now;
  // Next-up: within next 36 hours and not in the past
  return diff >= 0 && diff <= 36 * 60 * 60 * 1000;
}

/**
 * Parsers
 */
function parseTribeEventsV1(json){
  // Expected shape: { events: [...] }
  const arr = (json && json.events) ? json.events : [];
  return arr.map(ev => {
    // Start/end are often ISO-like strings
    const start = ev.start_date ? new Date(ev.start_date) : (ev.start_date_details?.year ? new Date(`${ev.start_date_details.year}-${ev.start_date_details.month}-${ev.start_date_details.day}T00:00:00`) : null);
    const end = ev.end_date ? new Date(ev.end_date) : (start ? new Date(start) : null);

    // Image field varies by version; try common candidates
    const img =
      ev.image?.url ||
      ev.image?.sizes?.large?.url ||
      ev.featured_image?.url ||
      ev.featured_image ||
      ev.thumbnail?.url ||
      "";

    const venue = ev.venue?.venue || ev.venue?.name || ev.venue?.address || "";

    return {
      title: safeText(ev.title),
      start,
      end: end || start,
      venue: safeText(venue),
      url: ev.url || "",
      image: img || ""
    };
  }).filter(e => e.start instanceof Date && !isNaN(e.start));
}

function parseWpV2TribeEvents(json){
  const arr = Array.isArray(json) ? json : [];
  return arr.map(ev => {
    // Dates may not be present without specific plugin support; try a few possibilities.
    const start =
      ev.start_date ? new Date(ev.start_date) :
      ev.meta?.start_date ? new Date(ev.meta.start_date) :
      ev._EventStartDate ? new Date(ev._EventStartDate) :
      ev.date ? new Date(ev.date) :
      null;

    const end =
      ev.end_date ? new Date(ev.end_date) :
      ev.meta?.end_date ? new Date(ev.meta.end_date) :
      ev._EventEndDate ? new Date(ev._EventEndDate) :
      (start ? new Date(start) : null);

    // Featured image via _embed
    const img =
      ev._embedded?.["wp:featuredmedia"]?.[0]?.source_url ||
      ev._embedded?.["wp:featuredmedia"]?.[0]?.media_details?.sizes?.large?.source_url ||
      ev._embedded?.["wp:featuredmedia"]?.[0]?.media_details?.sizes?.medium_large?.source_url ||
      "";

    // Venue often not exposed here; keep blank.
    return {
      title: safeText(ev.title?.rendered || ""),
      start,
      end: end || start,
      venue: "",
      url: ev.link || "",
      image: img || ""
    };
  }).filter(e => e.start instanceof Date && !isNaN(e.start));
}

/**
 * Rendering
 */
function render(events){
  // Sort by start date
  events.sort((a,b) => a.start - b.start);

  // Group by month
  const grouped = new Map();
  for (const e of events){
    const key = fmtMonthKey(e.start);
    if (!grouped.has(key)) grouped.set(key, []);
    grouped.get(key).push(e);
  }

  // Choose first N months with events
  const monthKeys = Array.from(grouped.keys()).slice(0, CONFIG.monthsToShow);

  const content = $("content");
  content.innerHTML = "";

  if (monthKeys.length === 0){
    content.innerHTML = `<div class="status">No upcoming events found.</div>`;
    return;
  }

  for (const key of monthKeys){
    const h = document.createElement("div");
    h.className = "month";
    h.textContent = key;
    content.appendChild(h);

    const grid = document.createElement("div");
    grid.className = "grid";

    const monthEvents = grouped.get(key).slice(0, CONFIG.cardsPerMonth);
    for (const ev of monthEvents){
      const card = document.createElement("div");
      card.className = "card";

      const badge = isNextUp(ev.start) ? `<div class="badge">Next Up</div>` : "";
      const imgSrc = ev.image ? ev.image : FALLBACK_IMAGE;

      // NOTE: always <img> (not CSS background images)
      card.innerHTML = `
        ${badge}
        <img src="${escapeAttr(imgSrc)}" alt="">
        <div class="overlay"></div>
        <div class="card-content">
          <h2>${escapeHtml(ev.title)}</h2>
          <div class="meta">
            ${escapeHtml(fmtDateTimeRange(ev.start, ev.end))}
            ${ev.venue ? " · " + escapeHtml(ev.venue) : ""}
          </div>
        </div>
      `;

      // If the image fails to load, swap to fallback.
      const img = card.querySelector("img");
      img.addEventListener("error", () => { img.src = FALLBACK_IMAGE; }, { once:true });

      grid.appendChild(card);
    }

    content.appendChild(grid);
  }

  const footer = document.createElement("div");
  footer.className = "tiny";
  footer.innerHTML = `
    <span class="pill">Auto-updates</span>
    <span class="pill">Source: friendshipheightsmd.gov</span>
    <span class="pill">Updated: ${escapeHtml(new Date().toLocaleString("en-US", { timeZone: CONFIG.timezone }))}</span>
  `;
  content.appendChild(document.createElement("div")).className = "hr";
  content.appendChild(footer);
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," ").trim(); }

/**
 * Fetch with fallback
 */
async function loadEvents(){
  for (const feed of FEEDS){
    try{
      const res = await fetch(feed.url, {
        method: "GET",
        // If the server allows CORS, this will work. If it doesn't, browser will block.
        mode: "cors",
        cache: "no-store",
        credentials: "omit"
      });

      if (!res.ok) throw new Error(`${feed.name} HTTP ${res.status}`);
      const json = await res.json();

      const events = feed.parse(json);

      if (events && events.length){
        render(events);
        return;
      }
      // If parsed empty, try next feed.
    } catch (err){
      // try next feed
      console.warn("Feed failed:", feed.name, err);
    }
  }

  // If we got here, all feeds failed.
  renderError();
}

function renderError(){
  const content = $("content");
  content.innerHTML = `
    <div class="status">
      Unable to load events.
    </div>
    <div class="tiny">
      This usually means your browser blocked the cross-site request from GitHub Pages to friendshipheightsmd.gov (CORS).
      <div style="margin-top:14px;"></div>
      <strong>Quick fix options:</strong><br>
      1) Host this same HTML on friendshipheightsmd.gov (best), or<br>
      2) Ask the site admin to enable CORS for the Events API endpoints, or<br>
      3) Use a small server-side proxy (I can provide one if needed).
      <div style="margin-top:14px;"></div>
      <span class="pill">Tip</span> If you open your browser DevTools Console, you’ll likely see a CORS error message.
    </div>
  `;
}

loadEvents();

// Optional auto-refresh for signage reliability
if (CONFIG.refreshMinutes && CONFIG.refreshMinutes > 0){
  setInterval(() => loadEvents(), CONFIG.refreshMinutes * 60 * 1000);
}
</script>
</body>
</html>
