name: Update events.json

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch shortlist HTML (always)
        run: |
          set -e
          curl -sS "https://friendshipheightsmd.gov/event-shortlist/" > shortlist.html

      - name: Try Events API (best) but don't fail build
        run: |
          set +e
          curl -sS "https://friendshipheightsmd.gov/wp-json/tribe/events/v1/events?per_page=50&page=1&orderby=start_date&order=asc" > api.json
          exit 0

      - name: Build events.json (API-first, fallback to HTML scrape)
        run: |
          node - <<'NODE'
          const fs = require("fs");

          function stripTags(s){ return (s||"").replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim(); }

          function fromApi() {
            try {
              const raw = JSON.parse(fs.readFileSync("api.json","utf8"));
              const arr = raw && raw.events ? raw.events : [];
              const events = arr.map(e => {
                const img =
                  (e.image && e.image.url) ||
                  (e.image && e.image.sizes && e.image.sizes.large && e.image.sizes.large.url) ||
                  (e.featured_image && e.featured_image.url) ||
                  e.featured_image ||
                  "";
                const venue = (e.venue && (e.venue.venue || e.venue.name)) || "";
                return {
                  title: stripTags(e.title),
                  start: e.start_date || "",
                  end: e.end_date || e.start_date || "",
                  venue,
                  image: img
                };
              }).filter(x => x.start);
              return events.length ? events : null;
            } catch {
              return null;
            }
          }

          function fromShortlistHtml() {
            const html = fs.readFileSync("shortlist.html","utf8");

            // This is a lightweight scrape aimed at “good enough” signage.
            // It extracts event blocks that look like:
            // ##   Title
            // 30 Dec
            // 12:00 pm - 4:00 pm  at Community Center
            //
            // We also try to find an image URL near each item, but if not found the page will use fallback images.

            // Grab month sections and event cards from the rendered HTML text structure.
            // We'll pull the first ~30 event titles and their detail lines.
            const events = [];

            // A forgiving regex: find headings with "##" and capture the next few lines
            const re = /##\s+([^\n]+)\n([\s\S]{0,180})?Find out more/gi;

            let m;
            while ((m = re.exec(html)) && events.length < 60) {
              const title = stripTags(m[1]);

              const blob = (m[2] || "").replace(/\r/g,"");
              // Try to find a date like "30  Dec" or "2  Jan"
              const dateMatch = blob.match(/(\d{1,2})\s+([A-Za-z]{3})/);
              const timeMatch = blob.match(/(\d{1,2}:\d{2}\s*(?:am|pm))\s*-\s*(\d{1,2}:\d{2}\s*(?:am|pm))/i);
              const allDayMatch = blob.match(/All-day event/i);
              const venueMatch = blob.match(/at\s+([^\n]+)/i);

              // Build a rough ISO date using current year/month context is hard from this page;
              // BUT the event-shortlist page is ordered and the signage display mainly needs title + time.
              // We'll set start/end to "now" if we can't parse, so it still displays; the client groups by month
              // only when it has real dates. So we'll also try to infer the year:
              const now = new Date();
              const year = now.getFullYear();
              const monthMap = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};

              let startISO = "";
              let endISO = "";

              if (dateMatch) {
                const day = parseInt(dateMatch[1],10);
                const mon = monthMap[dateMatch[2]] ?? null;
                if (mon !== null) {
                  // If month is “behind” current month by a lot, bump year (e.g., Jan when now is Dec)
                  let y = year;
                  const curMon = now.getMonth();
                  if (curMon === 11 && mon <= 1) y = year + 1;

                  // Time handling
                  function parseTime(t){
                    const mm = t.match(/(\d{1,2}):(\d{2})\s*(am|pm)/i);
                    if(!mm) return {h:0,min:0};
                    let h = parseInt(mm[1],10);
                    const min = parseInt(mm[2],10);
                    const ap = mm[3].toLowerCase();
                    if (ap === "pm" && h !== 12) h += 12;
                    if (ap === "am" && h === 12) h = 0;
                    return {h,min};
                  }

                  if (allDayMatch) {
                    const d = new Date(Date.UTC(y, mon, day, 0, 0, 0));
                    startISO = d.toISOString();
                    endISO = d.toISOString();
                  } else if (timeMatch) {
                    const st = parseTime(timeMatch[1]);
                    const et = parseTime(timeMatch[2]);
                    const start = new Date(y, mon, day, st.h, st.min, 0);
                    const end = new Date(y, mon, day, et.h, et.min, 0);
                    startISO = start.toISOString();
                    endISO = end.toISOString();
                  } else {
                    const d = new Date(y, mon, day, 0, 0, 0);
                    startISO = d.toISOString();
                    endISO = d.toISOString();
                  }
                }
              }

              const venue = venueMatch ? stripTags(venueMatch[1]) : "";

              if (title) {
                events.push({
                  title,
                  start: startISO || new Date().toISOString(),
                  end: endISO || new Date().toISOString(),
                  venue,
                  image: "" // leave blank; client will use fallback image
                });
              }
            }

            return events.length ? events : [];
          }

          const apiEvents = fromApi();
          const events = apiEvents || fromShortlistHtml();

          const out = {
            generated_at: new Date().toISOString(),
            source: apiEvents ? "tribe_events_api" : "shortlist_html_scrape",
            events
          };

          fs.writeFileSync("events.json", JSON.stringify(out, null, 2));
          console.log("Wrote events:", events.length, "source:", out.source);
          NODE

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add events.json
          git diff --cached --quiet || (git commit -m "Update events.json" && git push)
